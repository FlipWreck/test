//@version=5
indicator("Smart Pattern Detector - All Patterns", overlay=true, max_lines_count=500, max_labels_count=500)

// ========== INPUT PARAMETERS ==========
lookback = input.int(50, "Lookback Period", minval=10, maxval=200)
pivotStrength = input.int(5, "Pivot Strength", minval=2, maxval=10)
showWedges = input.bool(true, "Show Wedges", group="Patterns")
showTriangles = input.bool(true, "Show Triangles", group="Patterns")
showHeadShoulders = input.bool(true, "Show Head & Shoulders", group="Patterns")
showDoubleTopBottom = input.bool(true, "Show Double Top/Bottom", group="Patterns")
showFlags = input.bool(true, "Show Flags & Pennants", group="Patterns")
showChannels = input.bool(true, "Show Channels", group="Patterns")

// ========== PIVOT DETECTION ==========
pivotHigh = ta.pivothigh(high, pivotStrength, pivotStrength)
pivotLow = ta.pivotlow(low, pivotStrength, pivotStrength)

// Store pivot points
var array<float> highPivots = array.new<float>()
var array<int> highPivotBars = array.new<int>()
var array<float> lowPivots = array.new<float>()
var array<int> lowPivotBars = array.new<int>()

if not na(pivotHigh)
    array.unshift(highPivots, pivotHigh)
    array.unshift(highPivotBars, bar_index - pivotStrength)
    if array.size(highPivots) > 10
        array.pop(highPivots)
        array.pop(highPivotBars)

if not na(pivotLow)
    array.unshift(lowPivots, pivotLow)
    array.unshift(lowPivotBars, bar_index - pivotStrength)
    if array.size(lowPivots) > 10
        array.pop(lowPivots)
        array.pop(lowPivotBars)

// ========== FALLING WEDGE DETECTION ==========
detectFallingWedge() =>
    result = false
    if array.size(highPivots) >= 2 and array.size(lowPivots) >= 2
        h1 = array.get(highPivots, 1)
        h2 = array.get(highPivots, 0)
        l1 = array.get(lowPivots, 1)
        l2 = array.get(lowPivots, 0)
        
        hb1 = array.get(highPivotBars, 1)
        hb2 = array.get(highPivotBars, 0)
        lb1 = array.get(lowPivotBars, 1)
        lb2 = array.get(lowPivotBars, 0)
        
        // Falling wedge: both lines declining, but lower line declining faster
        upperSlope = (h2 - h1) / (hb2 - hb1)
        lowerSlope = (l2 - l1) / (lb2 - lb1)
        
        if upperSlope < 0 and lowerSlope < 0 and lowerSlope < upperSlope
            result := true
            if showWedges
                line.new(hb1, h1, hb2, h2, color=color.blue, width=2, style=line.style_solid)
                line.new(lb1, l1, lb2, l2, color=color.blue, width=2, style=line.style_solid)
                label.new(bar_index, high, "Falling Wedge", color=color.new(color.blue, 80), textcolor=color.blue, style=label.style_label_down, size=size.small)
    result

// ========== RISING WEDGE DETECTION ==========
detectRisingWedge() =>
    result = false
    if array.size(highPivots) >= 2 and array.size(lowPivots) >= 2
        h1 = array.get(highPivots, 1)
        h2 = array.get(highPivots, 0)
        l1 = array.get(lowPivots, 1)
        l2 = array.get(lowPivots, 0)
        
        hb1 = array.get(highPivotBars, 1)
        hb2 = array.get(highPivotBars, 0)
        lb1 = array.get(lowPivotBars, 1)
        lb2 = array.get(lowPivotBars, 0)
        
        // Rising wedge: both lines rising, but upper line rising slower
        upperSlope = (h2 - h1) / (hb2 - hb1)
        lowerSlope = (l2 - l1) / (lb2 - lb1)
        
        if upperSlope > 0 and lowerSlope > 0 and upperSlope < lowerSlope
            result := true
            if showWedges
                line.new(hb1, h1, hb2, h2, color=color.red, width=2, style=line.style_solid)
                line.new(lb1, l1, lb2, l2, color=color.red, width=2, style=line.style_solid)
                label.new(bar_index, high, "Rising Wedge", color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_down, size=size.small)
    result

// ========== ASCENDING TRIANGLE ==========
detectAscendingTriangle() =>
    result = false
    if array.size(highPivots) >= 2 and array.size(lowPivots) >= 2
        h1 = array.get(highPivots, 1)
        h2 = array.get(highPivots, 0)
        l1 = array.get(lowPivots, 1)
        l2 = array.get(lowPivots, 0)
        
        hb1 = array.get(highPivotBars, 1)
        hb2 = array.get(highPivotBars, 0)
        lb1 = array.get(lowPivotBars, 1)
        lb2 = array.get(lowPivotBars, 0)
        
        // Ascending triangle: flat top, rising bottom
        upperFlat = math.abs(h2 - h1) / h1 < 0.02
        lowerRising = l2 > l1
        
        if upperFlat and lowerRising
            result := true
            if showTriangles
                line.new(hb1, h1, hb2, h2, color=color.green, width=2, style=line.style_solid)
                line.new(lb1, l1, lb2, l2, color=color.green, width=2, style=line.style_solid)
                label.new(bar_index, high, "Ascending Triangle", color=color.new(color.green, 80), textcolor=color.green, style=label.style_label_down, size=size.small)
    result

// ========== DESCENDING TRIANGLE ==========
detectDescendingTriangle() =>
    result = false
    if array.size(highPivots) >= 2 and array.size(lowPivots) >= 2
        h1 = array.get(highPivots, 1)
        h2 = array.get(highPivots, 0)
        l1 = array.get(lowPivots, 1)
        l2 = array.get(lowPivots, 0)
        
        hb1 = array.get(highPivotBars, 1)
        hb2 = array.get(highPivotBars, 0)
        lb1 = array.get(lowPivotBars, 1)
        lb2 = array.get(lowPivotBars, 0)
        
        // Descending triangle: flat bottom, falling top
        lowerFlat = math.abs(l2 - l1) / l1 < 0.02
        upperFalling = h2 < h1
        
        if lowerFlat and upperFalling
            result := true
            if showTriangles
                line.new(hb1, h1, hb2, h2, color=color.orange, width=2, style=line.style_solid)
                line.new(lb1, l1, lb2, l2, color=color.orange, width=2, style=line.style_solid)
                label.new(bar_index, high, "Descending Triangle", color=color.new(color.orange, 80), textcolor=color.orange, style=label.style_label_down, size=size.small)
    result

// ========== SYMMETRICAL TRIANGLE ==========
detectSymmetricalTriangle() =>
    result = false
    if array.size(highPivots) >= 2 and array.size(lowPivots) >= 2
        h1 = array.get(highPivots, 1)
        h2 = array.get(highPivots, 0)
        l1 = array.get(lowPivots, 1)
        l2 = array.get(lowPivots, 0)
        
        hb1 = array.get(highPivotBars, 1)
        hb2 = array.get(highPivotBars, 0)
        lb1 = array.get(lowPivotBars, 1)
        lb2 = array.get(lowPivotBars, 0)
        
        // Symmetrical triangle: converging lines
        upperSlope = (h2 - h1) / (hb2 - hb1)
        lowerSlope = (l2 - l1) / (lb2 - lb1)
        
        if upperSlope < 0 and lowerSlope > 0 and math.abs(upperSlope) < math.abs(lowerSlope) * 2 and math.abs(lowerSlope) < math.abs(upperSlope) * 2
            result := true
            if showTriangles
                line.new(hb1, h1, hb2, h2, color=color.purple, width=2, style=line.style_solid)
                line.new(lb1, l1, lb2, l2, color=color.purple, width=2, style=line.style_solid)
                label.new(bar_index, high, "Symmetrical Triangle", color=color.new(color.purple, 80), textcolor=color.purple, style=label.style_label_down, size=size.small)
    result

// ========== HEAD AND SHOULDERS ==========
detectHeadShoulders() =>
    result = false
    if array.size(highPivots) >= 3
        leftShoulder = array.get(highPivots, 2)
        head = array.get(highPivots, 1)
        rightShoulder = array.get(highPivots, 0)
        
        lsBar = array.get(highPivotBars, 2)
        headBar = array.get(highPivotBars, 1)
        rsBar = array.get(highPivotBars, 0)
        
        // Head should be higher than both shoulders
        if head > leftShoulder and head > rightShoulder and math.abs(leftShoulder - rightShoulder) / leftShoulder < 0.03
            result := true
            if showHeadShoulders
                line.new(lsBar, leftShoulder, headBar, head, color=color.maroon, width=2)
                line.new(headBar, head, rsBar, rightShoulder, color=color.maroon, width=2)
                label.new(bar_index, high, "Head & Shoulders", color=color.new(color.maroon, 80), textcolor=color.maroon, style=label.style_label_down, size=size.small)
    result

// ========== DOUBLE TOP ==========
detectDoubleTop() =>
    result = false
    if array.size(highPivots) >= 2
        top1 = array.get(highPivots, 1)
        top2 = array.get(highPivots, 0)
        
        t1Bar = array.get(highPivotBars, 1)
        t2Bar = array.get(highPivotBars, 0)
        
        // Tops should be approximately equal
        if math.abs(top1 - top2) / top1 < 0.02
            result := true
            if showDoubleTopBottom
                line.new(t1Bar, top1, t2Bar, top2, color=color.red, width=2, style=line.style_dashed)
                label.new(bar_index, high, "Double Top", color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_down, size=size.small)
    result

// ========== DOUBLE BOTTOM ==========
detectDoubleBottom() =>
    result = false
    if array.size(lowPivots) >= 2
        bottom1 = array.get(lowPivots, 1)
        bottom2 = array.get(lowPivots, 0)
        
        b1Bar = array.get(lowPivotBars, 1)
        b2Bar = array.get(lowPivotBars, 0)
        
        // Bottoms should be approximately equal
        if math.abs(bottom1 - bottom2) / bottom1 < 0.02
            result := true
            if showDoubleTopBottom
                line.new(b1Bar, bottom1, b2Bar, bottom2, color=color.green, width=2, style=line.style_dashed)
                label.new(bar_index, low, "Double Bottom", color=color.new(color.green, 80), textcolor=color.green, style=label.style_label_up, size=size.small)
    result

// ========== BULL FLAG ==========
detectBullFlag() =>
    result = false
    // Strong uptrend followed by consolidation
    priorTrend = ta.sma(close, 20)[20] < close[20]
    recentConsolidation = ta.stdev(close, 10) < ta.stdev(close, 50) * 0.5
    
    if priorTrend and recentConsolidation
        result := true
        if showFlags
            label.new(bar_index, low, "Bull Flag", color=color.new(color.lime, 80), textcolor=color.lime, style=label.style_label_up, size=size.small)
    result

// ========== BEAR FLAG ==========
detectBearFlag() =>
    result = false
    // Strong downtrend followed by consolidation
    priorTrend = ta.sma(close, 20)[20] > close[20]
    recentConsolidation = ta.stdev(close, 10) < ta.stdev(close, 50) * 0.5
    
    if priorTrend and recentConsolidation
        result := true
        if showFlags
            label.new(bar_index, high, "Bear Flag", color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_down, size=size.small)
    result

// ========== CHANNEL DETECTION ==========
detectChannel() =>
    result = false
    upperBand = ta.sma(high, 20) + ta.stdev(high, 20)
    lowerBand = ta.sma(low, 20) - ta.stdev(low, 20)
    
    // Check if price is respecting channel boundaries
    touchingUpper = high >= upperBand * 0.99
    touchingLower = low <= lowerBand * 1.01
    
    if (touchingUpper or touchingLower) and showChannels
        line.new(bar_index - 20, upperBand[20], bar_index, upperBand, color=color.gray, width=1, style=line.style_dashed)
        line.new(bar_index - 20, lowerBand[20], bar_index, lowerBand, color=color.gray, width=1, style=line.style_dashed)
        result := true
    result

// ========== EXECUTE PATTERN DETECTION ==========
if barstate.islast
    fallingWedge = detectFallingWedge()
    risingWedge = detectRisingWedge()
    ascTriangle = detectAscendingTriangle()
    descTriangle = detectDescendingTriangle()
    symTriangle = detectSymmetricalTriangle()
    headShoulders = detectHeadShoulders()
    doubleTop = detectDoubleTop()
    doubleBottom = detectDoubleBottom()
    bullFlag = detectBullFlag()
    bearFlag = detectBearFlag()
    channel = detectChannel()

// ========== ALERTS ==========
alertcondition(detectFallingWedge(), "Falling Wedge Detected", "Falling Wedge pattern found!")
alertcondition(detectRisingWedge(), "Rising Wedge Detected", "Rising Wedge pattern found!")
alertcondition(detectAscendingTriangle(), "Ascending Triangle Detected", "Ascending Triangle pattern found!")
alertcondition(detectDescendingTriangle(), "Descending Triangle Detected", "Descending Triangle pattern found!")

// Plot pivots for reference
plotshape(pivotHigh, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.tiny)
plotshape(pivotLow, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.tiny)